# 微服务设计：API Gateway模式

根据Gartner的定义，微服务是"微服务是封装紧密，松散耦合，可独立部署且可独立扩展的应用程序组件。" 微服务的目标是将应用程序充分分解/解耦为松散耦合的
微服务/模块。这与模块间高度耦合并且作为一个整体部署的单体应用程序是不同的。

这样做有以下好处：

- 每个微服务都可以独立的部署、升级、扩容、维护、重启等
- 跨团队敏捷开发和敏捷部署
- 可使用的技术和语言灵活并且具有很好的扩展性


### API Gateway的功能

#### 路由
封装底层系统并且与客户端解耦，为客户端提供了与微服务系统进行通信的单个入口点。

#### 减负

API Gateway整合了一些由各个微服务都要实现的边缘功能，这样，每个微服务只需要关心核心业务，不需要重复实现。这些功能包括：

- 认证和授权
- 集成服务发现
- 响应缓存
- 重试策略
- 熔断策略
- 服务质量（QoS）
- 频控和限流
- 负载均衡
- 日志打点、跟踪、关联
- 请求头、query和声明转换
- IP白名单

### BFF模式

它是API网关模式的一种变体。 它提供了基于客户端的多个网关。 目的是根据客户端的需求提供量身定制的API层，从而消除了为所有客户端制作通用API造成的体积膨胀。

#### AGW聚合服务

有些简单的API请求直接映射到单个服务API，API Gateway可以通过将请求路由到相应的微服务来进行服务。 但是，有些API请求比较复杂，需要从多个微服务获得结果，
这种情况可以通过API组合/聚合（分散-收集机制）来实现。 在需要同步通信的情况下，如果服务彼此依赖，则必须遵循链式组合模式。 聚合层必须支持很大一部分的ESB/
集成功能，例如转换，编排，弹性和稳定性模式。

通常会部署一个具有特殊的分发器和聚合器功能（或微服务）的根容器。 分发者负责将任务分解成更细的粒度，并将这些任务分发给微服务实例。 聚合器负责聚合业务工作流从组合微服务中
得出的结果。

### Service Mesh和API Gateway
Service Mesh是微服务中的一层可配置的网络基础设施。也通常被称为sidecar proxy。它也提供了许多功能, 比如：

- 负载均衡
- 服务发现
- 健康检查
- 安全

表面上看，API Gateway和Service Mesh解决了很多同样的问题，因此可能你会觉得API Gateway是多余的。但是实际上他们确实是解决了一些同样的问题，但是
他们的维度是不同的。

API Gateway作为业务解决方案的一部分部署，解决的是直接面对外部客户端的问题(南北问题)，而Service Mesh主要解决不同微服务间通信的问题(东西问题)。
实施Service Mesh可以让你的业务服务中不用处理熔断、服务发现、健康检查、服务可观测性之类的逻辑，对于大规模的微服务而言，这是非常有用的。但是对于小
规模的微服务，不一定非要用Service Mesh来进行故障管理，可以尝试一些其它的方案，因为Service Mesh会带来一定的复杂性。

API Gateway和Service Mesh这两种技术并不是互斥的，可以在业务中同时实现这两种技术。并且API Gateway本身也是一个微服务，因此本身也是可以接入Service Mesh
来治理的。



based on https://medium.com/dev-genius/microservices-design-api-gateway-pattern-980e8d02bdd5


